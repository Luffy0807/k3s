---
- name: Install k3s server on control-plane
  hosts: k3s_server
  become: true
  gather_facts: true

  vars:
    k3s_install_url: "https://raw.githubusercontent.com/k3s-io/k3s/main/install.sh"
    k3s_exec: "server --cluster-init --write-kubeconfig-mode 0644"

  tasks:
    - name: Check if k3s already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_bin

    - name: Download k3s installer script via curl (force IPv4, retries)
      ansible.builtin.shell: |
        set -e
        curl -4 -fsSL --connect-timeout 10 --max-time 120 "{{ k3s_install_url }}" -o /tmp/k3s-install.sh
        chmod 0755 /tmp/k3s-install.sh
      args:
        executable: /bin/bash
      register: dl_res
      retries: 5
      delay: 5
      until: dl_res.rc == 0

    - name: Run k3s installer (only if not installed)
      ansible.builtin.command: /tmp/k3s-install.sh
      environment:
        INSTALL_K3S_EXEC: "{{ k3s_exec }}"
      when: not k3s_bin.stat.exists

    - name: Ensure k3s service enabled and running
      ansible.builtin.service:
        name: k3s
        enabled: true
        state: started

    - name: Wait until API is up (k3s kubectl get nodes)
      ansible.builtin.command: /usr/local/bin/k3s kubectl get nodes -o wide
      register: nodes_out
      retries: 30
      delay: 2
      until: nodes_out.rc == 0

    - name: Show nodes
      ansible.builtin.debug:
        var: nodes_out.stdout_lines
